<section class="forest-data ">
  <h2 class="title">Gesti√≥n de Datos Forestales</h2>
  
  <!-- Estad√≠sticas -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number">{{ statistics.speciesCount }}</div>
      <div class="stat-label">Especies Registradas</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ statistics.treeDataCount }}</div>
      <div class="stat-label">Registros de √Årboles</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ statistics.uniqueSpeciesInData }}</div>
      <div class="stat-label">Especies con Datos</div>
    </div>
  </div>

  <!-- Navegaci√≥n por pesta√±as -->
  <div class="tab-navigation">
    <button 
      class="tab-button" 
      [class.active]="selectedTab === 'upload'"
      (click)="selectedTab = 'upload'">
      üìÅ Cargar Datos
    </button>
    <button 
      class="tab-button" 
      [class.active]="selectedTab === 'add-tree'"
      (click)="selectedTab = 'add-tree'">
      ‚ûï Agregar √Årbol
    </button>
    <button 
      class="tab-button" 
      [class.active]="selectedTab === 'species'"
      (click)="selectedTab = 'species'">
      üå≤ Especies ({{ species.length }})
    </button>
    <button 
      class="tab-button" 
      [class.active]="selectedTab === 'data'"
      (click)="selectedTab = 'data'">
      üìä Datos de √Årboles ({{ treeData.length }})
    </button>
  </div>

  <!-- Contenido de pesta√±as -->
  <div class="tab-content">
    
    <!-- Pesta√±a de carga -->
    <div *ngIf="selectedTab === 'upload'" class="upload-section">
      <div class="upload-card">
        <h3>Cargar Archivo Excel</h3>
        <p class="upload-description">
          Sube un archivo Excel con datos de especies forestales y mediciones de √°rboles.
          El archivo puede contener dos hojas: "Especies" y "Datos".
        </p>
        
        <div class="upload-area">
          <input 
            type="file" 
            id="fileInput" 
            accept=".xlsx,.xls" 
            (change)="onFileSelected($event)"
            class="file-input">
          <label for="fileInput" class="file-label">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">
              <strong>Haz clic para seleccionar archivo</strong>
              <br>o arrastra y suelta aqu√≠
            </div>
            <div class="upload-hint">Archivos Excel (.xlsx, .xls)</div>
          </label>
        </div>
        
        <!-- Indicador de carga -->
        <div *ngIf="isLoading" class="loading-indicator">
          <div class="spinner"></div>
          <span>Procesando archivo...</span>
        </div>
        
        <!-- Mensajes -->
        <div *ngIf="uploadMessage" class="message success">
          ‚úÖ {{ uploadMessage }}
        </div>
        <div *ngIf="uploadError" class="message error">
          ‚ùå {{ uploadError }}
        </div>
        
        <!-- Acciones -->
        <div class="upload-actions">
          <button class="btn btn-secondary" (click)="downloadTemplate()">
            üì• Descargar Plantilla
          </button>
          <button class="btn btn-primary" (click)="exportData()" [disabled]="species.length === 0">
            üì§ Exportar Datos
          </button>
          <button class="btn btn-danger" (click)="clearAllData()">
            üóëÔ∏è Limpiar Todo
          </button>
        </div>
      </div>
      
      <!-- Instrucciones -->
      <div class="instructions-card">
        <h4>Formato del Archivo Excel</h4>
        <div class="format-info">
          <div class="sheet-info">
            <h5>Hoja "Especies":</h5>
            <ul>
              <li><strong>nombre:</strong> Nombre com√∫n de la especie</li>
              <li><strong>Nombre Cient√≠fico:</strong> Nombre cient√≠fico</li>
              <li><strong>Densidad Madera:</strong> kg/m¬≥</li>
              <li><strong>Factor Forma:</strong> Factor de forma (0.3-0.6)</li>
              <li><strong>Factor Biomasa:</strong> Factor de conversi√≥n biomasa</li>
              <li><strong>Altura M√°xima:</strong> Altura m√°xima en metros</li>
              <li><strong>DAP M√°ximo:</strong> DAP m√°ximo en cm</li>
            </ul>
          </div>
          <div class="sheet-info">
            <h5>Hoja "Datos":</h5>
            <ul>
              <li><strong>especie:</strong> Nombre de la especie</li>
              <li><strong>DAP:</strong> Di√°metro a la altura del pecho (cm)</li>
              <li><strong>altura:</strong> Altura del √°rbol (m)</li>
              <li><strong>edad:</strong> Edad del √°rbol (a√±os) - opcional</li>
              <li><strong>sitio:</strong> Clase de sitio - opcional</li>
              <li><strong>ubicacion:</strong> Ubicaci√≥n - opcional</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Pesta√±a para agregar √°rbol -->
    <div *ngIf="selectedTab === 'add-tree'" class="add-tree-section">
      <div class="section-header">
        <h3>Agregar Nuevo √Årbol</h3>
      </div>
      
      <form class="tree-form" (ngSubmit)="addTreeData()" #treeForm="ngForm">
        <div class="form-grid">
          <div class="form-field">
            <label for="treeSpecies">Especie *</label>
            <select 
              id="treeSpecies" 
              name="treeSpecies" 
              [(ngModel)]="newTreeData.especie" 
              (change)="onSpeciesChange($event)"
              required 
              class="form-control">
              <option value="">Seleccione una especie</option>
              <option *ngFor="let species of species" [value]="species.nombre">
                {{ species.nombre }} ({{ species.nombreCientifico }})
              </option>
            </select>
          </div>
          
          <div class="form-field">
            <label for="treeDap">DAP (cm) *</label>
            <input 
               id="treeDap" 
               name="treeDap" 
               type="number" 
               step="0.1" 
               [(ngModel)]="newTreeData.dap" 
               (ngModelChange)="generateMissingDataPrompts()"
               required 
               min="0.1" 
               placeholder="ej. 29.87"
               class="form-control">
          </div>
          
          <div class="form-field">
            <label for="treeHeight">Altura (m) *</label>
            <input 
               id="treeHeight" 
               name="treeHeight" 
               type="number" 
               step="0.1" 
               [(ngModel)]="newTreeData.altura" 
               (ngModelChange)="generateMissingDataPrompts()"
               required 
               min="0.1" 
               placeholder="ej. 30.64"
               class="form-control">
          </div>
          
          <div class="form-field">
            <label for="treeAge">Edad (a√±os)</label>
            <input 
              id="treeAge" 
              name="treeAge" 
              type="number" 
              [(ngModel)]="newTreeData.edad" 
              min="1" 
              placeholder="ej. 15"
              class="form-control">
          </div>
          
          <div class="form-field">
            <label for="treeSite">Clase de Sitio</label>
            <select 
              id="treeSite" 
              name="treeSite" 
              [(ngModel)]="newTreeData.sitio" 
              class="form-control">
              <option value="">Seleccione clase de sitio</option>
              <option value="Clase I">I (Mejor calidad)</option>
              <option value="Clase II">II (Calidad media)</option>
              <option value="Clase III">III (Menor calidad)</option>
            </select>
          </div>
          
          <div class="form-field">
            <label for="treeLocation">Ubicaci√≥n</label>
            <input 
              id="treeLocation" 
              name="treeLocation" 
              type="text" 
              [(ngModel)]="newTreeData.ubicacion" 
              placeholder="ej. Parcela 1, Sector A"
              class="form-control">
          </div>
          
          <div class="form-field">
            <label for="treeDate">Fecha de Medici√≥n</label>
            <input 
              id="treeDate" 
              name="treeDate" 
              type="date" 
              [(ngModel)]="newTreeData.fecha" 
              class="form-control">
          </div>
          
          <div class="form-field full-width">
            <label for="treeObservations">Observaciones</label>
            <textarea 
              id="treeObservations" 
              name="treeObservations" 
              [(ngModel)]="newTreeData.observaciones" 
              rows="3" 
              placeholder="Observaciones adicionales..."
              class="form-control"></textarea>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="resetForm()">Limpiar</button>
          <button type="submit" class="btn btn-primary" [disabled]="!treeForm.valid">Agregar √Årbol</button>
        </div>
        
        <div *ngIf="selectedSpeciesInfo" class="species-info-card">
          <h4>Informaci√≥n de la Especie Seleccionada</h4>
          <div class="species-params">
            <div class="param">
              <span class="label">Densidad de Madera:</span>
              <span class="value">{{ selectedSpeciesInfo.densidadMadera }} kg/m¬≥</span>
            </div>
            <div class="param">
              <span class="label">Factor de Forma:</span>
              <span class="value">{{ selectedSpeciesInfo.factorForma }}</span>
            </div>
            <div class="param">
              <span class="label">Factor de Biomasa:</span>
              <span class="value">{{ selectedSpeciesInfo.factorBiomasa }}</span>
            </div>
            <div class="param">
              <span class="label">Altura M√°xima:</span>
              <span class="value">{{ selectedSpeciesInfo.alturaMaxima }} m</span>
            </div>
            <div class="param">
              <span class="label">DAP M√°ximo:</span>
              <span class="value">{{ selectedSpeciesInfo.dapMaximo }} cm</span>
            </div>
          </div>
          
          <div *ngIf="missingDataPrompts.length > 0" class="missing-data-prompts">
            <h5>‚ö†Ô∏è Datos Sugeridos para Completar:</h5>
            <ul>
              <li *ngFor="let prompt of missingDataPrompts">{{ prompt }}</li>
            </ul>
          </div>
        </div>
      </form>
    </div>

    <!-- Pesta√±a de especies -->
    <div *ngIf="selectedTab === 'species'" class="species-section">
      <div class="section-header">
        <h3>Base de Datos de Especies</h3>
        <div class="search-box">
          <input 
            type="text" 
            placeholder="Buscar especies..." 
            [(ngModel)]="speciesFilter"
            class="search-input">
        </div>
      </div>
      
      <div class="species-grid">
        <div *ngFor="let species of filteredSpecies" class="species-card">
          <div class="species-header">
            <h4>{{ species.nombre }}</h4>
            <button class="delete-btn" (click)="deleteSpecies(species.id)" title="Eliminar especie">
              üóëÔ∏è
            </button>
          </div>
          <p class="scientific-name">{{ species.nombreCientifico }}</p>
          <div class="species-details">
            <div class="detail-row">
              <span class="label">Densidad:</span>
              <span class="value">{{ species.densidadMadera }} kg/m¬≥</span>
            </div>
            <div class="detail-row">
              <span class="label">Factor Forma:</span>
              <span class="value">{{ species.factorForma }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Factor Biomasa:</span>
              <span class="value">{{ species.factorBiomasa }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Altura M√°x:</span>
              <span class="value">{{ species.alturaMaxima }} m</span>
            </div>
            <div class="detail-row">
              <span class="label">DAP M√°x:</span>
              <span class="value">{{ species.dapMaximo }} cm</span>
            </div>
          </div>
          <p *ngIf="species.descripcion" class="species-description">
            {{ species.descripcion }}
          </p>
        </div>
      </div>
      
      <div *ngIf="filteredSpecies.length === 0" class="empty-state">
        <div class="empty-icon">üå≤</div>
        <h4>No se encontraron especies</h4>
        <p>{{ speciesFilter ? 'Intenta con otros t√©rminos de b√∫squeda' : 'Carga un archivo Excel para agregar especies' }}</p>
      </div>
    </div>

    <!-- Pesta√±a de datos de √°rboles -->
    <div *ngIf="selectedTab === 'data'" class="tree-data-section">
      <div class="section-header">
        <h3>Registros de √Årboles</h3>
        <div class="header-actions">
          <div class="search-box">
            <input 
              type="text" 
              placeholder="Buscar por especie, ubicaci√≥n..." 
              [(ngModel)]="dataFilter"
              class="search-input">
          </div>
          <button 
            class="btn btn-danger" 
            (click)="clearAllTreeData()"
            [disabled]="treeData.length === 0"
            title="Borrar todos los datos de √°rboles">
            üóëÔ∏è Borrar Todos
          </button>
        </div>
      </div>
      
      <div class="data-table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Especie</th>
              <th>DAP (cm)</th>
              <th>Altura (m)</th>
              <th>Edad</th>
              <th>Sitio</th>
              <th>Ubicaci√≥n</th>
              <th>Fecha</th>
              <th>Observaciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let data of filteredTreeData; let i = index">
              <td class="species-cell">{{ data.especie }}</td>
              <td class="number-cell">{{ data.dap | number:'1.1-1' }}</td>
              <td class="number-cell">{{ data.altura | number:'1.1-1' }}</td>
              <td class="number-cell">{{ data.edad || '-' }}</td>
              <td>{{ data.sitio || '-' }}</td>
              <td>{{ data.ubicacion || '-' }}</td>
              <td>{{ data.fecha || '-' }}</td>
              <td class="notes-cell">{{ data.observaciones || '-' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div *ngIf="filteredTreeData.length === 0" class="empty-state">
        <div class="empty-icon">üìä</div>
        <h4>No hay datos de √°rboles</h4>
        <p>{{ dataFilter ? 'No se encontraron registros con esos criterios' : 'Carga un archivo Excel para agregar datos de √°rboles' }}</p>
      </div>
    </div>
  </div>
</section>